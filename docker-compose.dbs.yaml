version: '3.4'

services:

  cassandrasmfr:
    build:
      context: ./
      dockerfile: cassandrasmfr/Dockerfile
      args:
        http_proxy: ${http_proxy}
        https_proxy: ${https_proxy}
    image: ${DOCKER_REGISTRY}/${CASSANDRA_IMAGE}:${image_tag}
    restart: always
    volumes:
    - vlm-cassandra:/var/lib/cassandra:rw
    container_name: cassandrasmfr
    networks:
    - back-tier
    ports:
    - '9042:9042'
    - '9160:9160'
    - '7000:7000'
    - '7001:7001'
    - '7199:7199'
    cap_add:
    - ALL
    privileged: true
    environment:
      MAX_HEAP_SIZE: 16G
      HEAP_NEWSIZE: 1800M
      JVM_OPTS: -Xms16g -Xmx16g -Dcom.sun.management.jmxremote.authenticate=true -Dcom.sun.management.jmxremote.password.file=/etc/cassandra/jmxremote.password -Dcom.sun.management.jmxremote.access.file=/etc/cassandra/jmxremote.access
      CASSANDRA_START_RPC: "true"
      CASSANDRA_LISTEN_ADDRESS: auto
      CASSANDRA_RPC_ADDRESS: 0.0.0.0
      CASSANDRA_BROADCAST_ADDRESS: cassandrasmfr
      CASSANDRA_NUM_TOKENS: 256
      LOCAL_JMX: "no"

  geonames:
    build:
      context: ./
      args:
        http_proxy: ${http_proxy}
        https_proxy: ${https_proxy}
      dockerfile: geonames/Dockerfile
    image: ${DOCKER_REGISTRY}/${GEONAMES_IMAGE}:${image_tag}
    restart: always
    working_dir: /geonames
    container_name: geonames
    ports:
      - '9200:9200'
      - '9300:9300'
    networks:
      - back-tier
    environment:
      bootstrap.memory_lock: 'true'
      discovery.type: 'single-node'
    volumes:
      - geonames_index:/usr/share/elasticsearch/data:rw

  mysql:
    build:
      context: ./
      dockerfile: mysql/Dockerfile
    image: ${DOCKER_REGISTRY}/${MYSQL_IMAGE}:${image_tag}
    restart: always
    container_name: mysql
    ports:
      - '3306:3306'
    volumes:
      - vlm-mysql:/var/lib/mysql:rw
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DBNAME}
      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
    networks:
      - back-tier

volumes:
  vlm-cassandra:
  vlm-mysql:
  geonames_index:

networks:
  back-tier:
