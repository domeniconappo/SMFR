{% extends "base.html" %}

{% block styles%}
    {{ super() }}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
   integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
   crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
    <link rel="stylesheet" href="/static/css/leaflet.extra-markers.min.css">
{% endblock %}

{% block app_content %}
<div class="row">
    <div class="col-lg-5">
        <table class="table table-striped table-bordered table-list">
        <thead>
            <tr>
                <th>Filename</th>
                <th>Date</th>
            </tr>
        </thead>

        <tbody>
        {%  if files %}
          {% for f in files %}
                <tr>
                    <td><a href="/products?date={{ f.date }}&type={{ f.type }}">{{ f.name }}</a></td>
                    <td>{{ f.date }}</td>
                </tr>
          {% endfor %}
        {% endif %}
        </tbody>

        </table>
    </div>

    <div class="col-lg-7">
        <div class="panel panel-default panel-table">
            <div class="panel-heading">
                <h3 class="panel-title">MAP</h3>
            </div>
            <div class="panel-body">
                <div id="product_map"></div>
            </div>
        </div>
    </div>
</div>

    {% if development %}
        <div class="row"><div class="col-lg-12">
            <div class="panel panel-default panel-table">
            <div class="panel-heading">
                <h3 class="panel-title">Geojson debug panel</h3>
            </div>
            <div class="panel-body">
                {{ geojson | tojson  }}
            </div>
        </div>
        </div></div>
    {% endif %}
{{ super() }}
{% endblock app_content %}


{% block scripts %}
    {{ super() }}
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
   integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
   crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script src="/static/js/leaflet.extra-markers.min.js"></script>
    <script>
    $(document).ready(function() {

        var clat = 55.0;
        var clon = 15.0;
        var map = L.map('product_map').setView([clat, clon], 4);
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZG9tZW5pY28tbmFwcG8iLCJhIjoiY2ptdnowNTQzMGMzeDNxbmtyeHlva2JuNiJ9.VI1pXr3ZUdnN31NwbUgIEw', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox.streets'
        }).addTo(map);
        var markers = L.markerClusterGroup({
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: true,
            zoomToBoundsOnClick: true
        });

        {% if geojson %}
            var features = {{ geojson | tojson }};
            var geojsonmap = L.geoJSON(features, {
                 onEachFeature: onEachFeature,
                 style: function(feature) {
                     if (feature.properties.type === 'heatmap') {
                         switch (feature.properties.risk_color) {
                             case '225 225 225':
                                 return {color: "#575757", weight: 3, opacity: 0.9, fillColor: "#ababab"};
                             case '255 0 0':
                                 return {color: "#b40000", weight: 5, opacity: 0.9, fillColor: "#ff646e"};
                             case '255 128 0':
                                 return {color: "#b8711b", weight: 4, opacity: 0.9, fillColor: "#d0af2a"};
                         }
                     }
                 }
            }).addTo(map);

            function onEachFeature(feature, layer) {
                var marker;
                var text;
                var counters;
                var lat;
                var lon;
                switch (feature.properties.type) {
                    case 'heatmap': {
                        counters = feature.properties.counters;
                        text = '<br />' + feature.properties.efas_id + '<br />' + counters;
                        geojsonmap.eachLayer(function (layer) {
                            layer.bindPopup(text);
                        });
                    }
                    break;
                    case 'tweet': {
                        var tweet = feature.properties.tweet;
                        lat = tweet['geo']['latitude'];
                        lon = tweet['geo']['longitude'];
                        if (tweet['full_text'] !== undefined) {
                            text = tweet['full_text'];
                        } else {
                            text = tweet['tweet']['text'];
                        }
                     var tweet_text = tweet['created_at'] + '<br />' + text + '<br />' + tweet['label_predicted'];
                     marker = L.marker([lat, lon]);
                     marker.bindPopup(tweet_text);
                     markers.addLayer(marker);
                    }
                    break;
                    case 'incident': {
                        var incidentMarker = L.ExtraMarkers.icon({
                            icon: 'fa-car-crash',
                            markerColor: 'red',
                            shape: 'square',
                            prefix: 'fas'
                        });
                        var incident = feature.properties.incident;
                        var incident_lat = incident['lat'];
                        var incident_lon = incident['lon'];
                        text = incident['text'];
                        marker = L.marker([incident_lat, incident_lon], {icon: incidentMarker});
                        marker.bindPopup(text);
                        markers.addLayer(marker);

                    }
                    break;
                }

            }

            map.addLayer(markers);
        {% endif %}

    });
    </script>
{% endblock scripts %}